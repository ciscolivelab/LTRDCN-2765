
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../task4-vxlan-nxos/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.11">
    
    
      
        <title>Task 5 - Day 2 Opertions with CI Pipeline - Cisco Live 2023 LTRDCN-2765</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.85bb2934.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#task-5-day-2-operation-using-ci-pipeline" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cisco Live 2023 LTRDCN-2765" class="md-header__button md-logo" aria-label="Cisco Live 2023 LTRDCN-2765" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cisco Live 2023 LTRDCN-2765
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Task 5 - Day 2 Opertions with CI Pipeline
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ciscolivelab/LTRDCN-2765" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cisco Live 2023 LTRDCN-2765" class="md-nav__button md-logo" aria-label="Cisco Live 2023 LTRDCN-2765" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Cisco Live 2023 LTRDCN-2765
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ciscolivelab/LTRDCN-2765" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Task1-ansible-node0/" class="md-nav__link">
        Task 1 - Prepare Ansible node
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../task2-first-ansible/" class="md-nav__link">
        Task 2 - First Simple Ansible Playbook
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../task3-vxlan-jinja2-new/" class="md-nav__link">
        Task 3 - Use of Jinja2 templates with Ansible Playbook
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../task4-vxlan-nxos/" class="md-nav__link">
        Task 4 - Config switches using Ansible NXOS modules
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Task 5 - Day 2 Opertions with CI Pipeline
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Task 5 - Day 2 Opertions with CI Pipeline
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-playbook-to-verify-underlay-and-overlay" class="md-nav__link">
    Step 1: Playbook to verify underlay and overlay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-install-git-and-gitlab-runner" class="md-nav__link">
    Step 2: Install git and gitlab runner
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-version-control-playbooks" class="md-nav__link">
    Step 3: Version control playbooks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-add-ci-pipeline-file" class="md-nav__link">
    Step 4: Add CI pipeline file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-register-local-gitlab-runner" class="md-nav__link">
    Step 5: Register local gitlab-runner
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-add-stage-branch-and-add-new-vnis" class="md-nav__link">
    Step 6: Add stage branch and add new VNIs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-review-pipeline-testing-and-staging-results" class="md-nav__link">
    Step 7: Review pipeline testing and staging results
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-merge-to-main-branch" class="md-nav__link">
    Step 8: Merge to main branch
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-playbook-to-verify-underlay-and-overlay" class="md-nav__link">
    Step 1: Playbook to verify underlay and overlay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-install-git-and-gitlab-runner" class="md-nav__link">
    Step 2: Install git and gitlab runner
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-version-control-playbooks" class="md-nav__link">
    Step 3: Version control playbooks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-add-ci-pipeline-file" class="md-nav__link">
    Step 4: Add CI pipeline file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-register-local-gitlab-runner" class="md-nav__link">
    Step 5: Register local gitlab-runner
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-add-stage-branch-and-add-new-vnis" class="md-nav__link">
    Step 6: Add stage branch and add new VNIs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-review-pipeline-testing-and-staging-results" class="md-nav__link">
    Step 7: Review pipeline testing and staging results
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-merge-to-main-branch" class="md-nav__link">
    Step 8: Merge to main branch
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="task-5-day-2-operation-using-ci-pipeline">Task 5: Day 2 operation using CI Pipeline</h1>
<p>We will implement CI/CD pipeline for day 2 operation tasks in this section.  GitLab and GitLab runner will be used for this purpose</p>
<ul>
<li>GitLab is software development platform that incorporates multiple capabilities including Version Control, code review and CI/CD in single system</li>
<li>GitLab runner is an application that run tests &amp; results i.e., jobs in a pipeline and then send the results to GitLab</li>
<li>The cloud hosted GitLab is used in this lab, while the GitLab runner will be installed on the same local server which is used as Ansible host in this lab setup</li>
</ul>
<p>The process for creating a CI/CD pipeline with GitLab &amp; GitLab runner include below procedure:</p>
<ul>
<li>Create a project in GitLab</li>
<li>Install and register the GitLab Runner for your project</li>
<li>Define a CI/CD job (steps, tests) in a file named <code>.gitlab-ci.yml</code> in the root of the repository</li>
<li>Conditions/rules can be defined in <code>.gitlab-ci.yml</code> file (YAML syntax) that will perform a job and display the results in GitLab pipeline e.g. When a commit to repository is done then the runner may execute the job and display the results in GitLab pipeline</li>
</ul>
<p>In this section, CI/CD pipeline for day 2 operation tasks will be implemented.  Below steps will be done:</p>
<ul>
<li>Create an Ansible playbook to verify underlay and overlay</li>
<li>Version control for the EVPN Ansible playbooks using GitLab version control capabilities</li>
<li>Create CI pipeline using GitLab</li>
<li>Add new VNIs into existing fabric</li>
<li>Verify CI pipeline in test and staging stages</li>
<li>Commit the merger and verify CI Pipeline in production stage</li>
</ul>
<hr />
<h3 id="step-1-playbook-to-verify-underlay-and-overlay">Step 1: Playbook to verify underlay and overlay</h3>
<p>In this step, you will create the playbook to verify underlay and overlay operation. The playbook will be applied to all leaf switches to verify the below commands:</p>
<p><strong><em>Underlay</em></strong></p>
<pre><code>-   show ip ospf neighbor
-   show ip bgp sum
-   show ip pim neighbor
</code></pre>
<p><strong><em>Overlay</em></strong></p>
<pre><code>-   show nve vni
-   show nve peer
-   show ip route vrf Tenant-1
-   show bgp l2vpn evpn
-   show l2route evpn mac-ip all
</code></pre>
<ul>
<li>Switch to <strong>Atom</strong>.  On the left page <strong>right click</strong> on the folder <code>EVPN-Ansible</code> and create a new playbook named <code>verify_fabric.yml</code>.   Enter this file name and hit <strong>enter</strong>.  Then <strong>Copy</strong> and <strong>Paste</strong> the below content to this newly created file:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">leaf, jinja2_leaf</span>
<span class="w">    </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">    </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">verify underlay</span>
<span class="w">        </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">underlay_output</span>
<span class="w">        </span><span class="nt">cisco.nxos.nxos_command</span><span class="p">:</span>
<span class="w">          </span><span class="nt">commands</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show ip ospf neighbors</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show ip bgp sum</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show ip pim neighbor</span>
<span class="w">        </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">underlay</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">var=underlay_output.stdout_lines</span>
<span class="w">        </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">underlay</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">set_fact</span><span class="p">:</span>
<span class="w">          </span><span class="nt">savefile</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{underlay_output.stdout_lines</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">to_nice_yaml}}&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">local_action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">copy content=&quot;{{savefile}}&quot; dest=./underlay.txt</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Verify Overlay</span>
<span class="w">        </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay_output</span>
<span class="w">        </span><span class="nt">cisco.nxos.nxos_command</span><span class="p">:</span>
<span class="w">          </span><span class="nt">commands</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show nve vni</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show nve peer</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show ip route vrf Tenant-1</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show bgp l2vpn evpn</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show l2route evpn mac-ip all</span>
<span class="w">        </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">var=overlay_output.stdout_lines</span>
<span class="w">        </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">set_fact</span><span class="p">:</span>
<span class="w">          </span><span class="nt">savefile</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{overlay_output.stdout_lines</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">to_nice_yaml}}&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">local_action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">copy content=&quot;{{savefile}}&quot; dest=./overlay.txt</span>
</code></pre></div>
<ul>
<li>
<p><strong>Click</strong> <code>File</code> and <code>Save</code> on <strong>Atom</strong>. This will save the playbook, and also scp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package.</p>
</li>
<li>
<p>On the <strong>Ansible</strong> node (via <strong>MTPuTTy</strong>), run <strong>verify_fabric.yml</strong> playbook and verify the output for <strong>underlay</strong> by executing below command (using respective tag).  This command will show ospf, bgp and pim neighbors for all leaf switches:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>cd ~/EVPN-Ansible
ansible-playbook verify_fabric.yml --tags &quot;underlay&quot;
</code></pre></div>
<ul>
<li>
<p>Below screenshot shows the partial output of above command and shows ospf, bgp and pim neighbors for all leaf switches:</p>
<p><img alt="" src="../pic/5-2-1.png" /></p>
</li>
</ul>
<p>Here is complete log of execution of above playbook/command:</p>
<div class="highlight"><pre><span></span><code>root@ubuntu:~/EVPN-Ansible# ansible-playbook verify_fabric.yml --tags &quot;underlay&quot;

PLAY [leaf, jinja2_leaf] *********************************************************************************************************************************************************************************************

TASK [verify underlay] ***********************************************************************************************************************************************************************************************
ok: [198.18.4.101]
ok: [198.18.4.104]
ok: [198.18.4.103]

TASK [debug] *********************************************************************************************************************************************************************************************************
ok: [198.18.4.101] =&gt; {
    &quot;underlay_output.stdout_lines&quot;: [
        [
            &quot;OSPF Process ID 1 VRF default&quot;,
            &quot; Total number of neighbors: 2&quot;,
            &quot; Neighbor ID     Pri State            Up Time  Address         Interface&quot;,
            &quot; 192.168.0.6       1 FULL/ -          01:27:12 10.0.0.21       Eth1/1 &quot;,
            &quot; 192.168.0.7       1 FULL/ -          01:27:12 10.0.128.5      Eth1/2&quot;
        ],
        [
            &quot;BGP summary information for VRF default, address family IPv4 Unicast&quot;,
            &quot;BGP router identifier 192.168.0.8, local AS number 65000&quot;,
            &quot;BGP table version is 6, IPv4 Unicast config peers 2, capable peers 2&quot;,
            &quot;0 network entries and 0 paths using 0 bytes of memory&quot;,
            &quot;BGP attribute entries [0/0], BGP AS path entries [0/0]&quot;,
            &quot;BGP community entries [0/0], BGP clusterlist entries [4/16]&quot;,
            &quot;&quot;,
            &quot;Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd&quot;,
            &quot;192.168.0.6     4 65000     161     106        6    0    0 01:23:17 0         &quot;,
            &quot;192.168.0.7     4 65000     161     106        6    0    0 01:23:15 0&quot;
        ],
        [
            &quot;PIM Neighbor Status for VRF \&quot;default\&quot;&quot;,
            &quot;Neighbor        Interface            Uptime    Expires   DR       Bidir-  BFD    ECMP Redirect&quot;,
            &quot;                                                         Priority Capable State     Capable&quot;,
            &quot;10.0.0.21       Ethernet1/1          01:23:08  00:01:35  1        yes     n/a     no&quot;,
            &quot;10.0.128.5      Ethernet1/2          01:23:07  00:01:31  1        yes     n/a     no&quot;
        ]
    ]
}
ok: [198.18.4.104] =&gt; {
    &quot;underlay_output.stdout_lines&quot;: [
        [
            &quot;OSPF Process ID 1 VRF default&quot;,
            &quot; Total number of neighbors: 2&quot;,
            &quot; Neighbor ID     Pri State            Up Time  Address         Interface&quot;,
            &quot; 192.168.0.6       1 FULL/ -          1d04h    10.0.128.1      Eth1/1 &quot;,
            &quot; 192.168.0.7       1 FULL/ -          1d04h    10.0.128.17     Eth1/2&quot;
        ],
        [
            &quot;BGP summary information for VRF default, address family IPv4 Unicast&quot;,
            &quot;BGP router identifier 192.168.0.11, local AS number 65000&quot;,
            &quot;BGP table version is 5, IPv4 Unicast config peers 2, capable peers 2&quot;,
            &quot;0 network entries and 0 paths using 0 bytes of memory&quot;,
            &quot;BGP attribute entries [0/0], BGP AS path entries [0/0]&quot;,
            &quot;BGP community entries [0/0], BGP clusterlist entries [4/16]&quot;,
            &quot;&quot;,
            &quot;Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd&quot;,
            &quot;192.168.0.6     4 65000     672     662        5    0    0 07:03:12 0         &quot;,
            &quot;192.168.0.7     4 65000    1441    1433        5    0    0 22:36:01 0&quot;
        ],
        [
            &quot;PIM Neighbor Status for VRF \&quot;default\&quot;&quot;,
            &quot;Neighbor        Interface            Uptime    Expires   DR       Bidir-  BFD    ECMP Redirect&quot;,
            &quot;                                                         Priority Capable State     Capable&quot;,
            &quot;10.0.128.1      Ethernet1/1          08:51:43  00:01:28  1        yes     n/a     no&quot;,
            &quot;10.0.128.17     Ethernet1/2          22:36:23  00:01:23  1        yes     n/a     no&quot;
        ]
    ]
}
ok: [198.18.4.103] =&gt; {
    &quot;underlay_output.stdout_lines&quot;: [
        [
            &quot;OSPF Process ID 1 VRF default&quot;,
            &quot; Total number of neighbors: 2&quot;,
            &quot; Neighbor ID     Pri State            Up Time  Address         Interface&quot;,
            &quot; 192.168.0.6       1 FULL/ -          01:27:11 10.0.0.29       Eth1/1 &quot;,
            &quot; 192.168.0.7       1 FULL/ -          01:27:10 10.0.128.13     Eth1/2&quot;
        ],
        [
            &quot;BGP summary information for VRF default, address family IPv4 Unicast&quot;,
            &quot;BGP router identifier 192.168.0.10, local AS number 65000&quot;,
            &quot;BGP table version is 6, IPv4 Unicast config peers 2, capable peers 2&quot;,
            &quot;0 network entries and 0 paths using 0 bytes of memory&quot;,
            &quot;BGP attribute entries [0/0], BGP AS path entries [0/0]&quot;,
            &quot;BGP community entries [0/0], BGP clusterlist entries [4/16]&quot;,
            &quot;&quot;,
            &quot;Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd&quot;,
            &quot;192.168.0.6     4 65000     148     107        6    0    0 01:23:17 0         &quot;,
            &quot;192.168.0.7     4 65000     150     107        6    0    0 01:23:17 0&quot;
        ],
        [
            &quot;PIM Neighbor Status for VRF \&quot;default\&quot;&quot;,
            &quot;Neighbor        Interface            Uptime    Expires   DR       Bidir-  BFD    ECMP Redirect&quot;,
            &quot;                                                         Priority Capable State     Capable&quot;,
            &quot;10.0.0.29       Ethernet1/1          01:23:09  00:01:37  1        yes     n/a     no&quot;,
            &quot;10.0.128.13     Ethernet1/2          01:23:08  00:01:23  1        yes     n/a     no&quot;
        ]
    ]
}

PLAY RECAP ***********************************************************************************************************************************************************************************************************
198.18.4.101               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
198.18.4.103               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
198.18.4.104               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre></div>
<p><strong>Next:</strong></p>
<ul>
<li>On the <strong>Ansible</strong> node (via <strong>MTPutty</strong>), execute the <strong>verify_fabric.yml</strong> playbook by issuing below command.  As per below, this command uses the <code>--tags</code> in the syntax to execute the respective tasks (as per the tag) in the playbook.  As per the output, <strong>verify</strong> the <strong>overlay</strong> outputs (as shown below).  <em>Note:</em> This command will show the nve tunnel peer, host route in BGP EVPN from all leaf switches:</li>
</ul>
<div class="highlight"><pre><span></span><code>ansible-playbook verify_fabric.yml --tags &quot;overlay&quot;
</code></pre></div>
<ul>
<li>
<p>Below screenshot of the partial output of above command:</p>
<p><img alt="" src="../pic/5-2-2.png" /></p>
</li>
<li>
<p>Below shows the complete log output of execution of above playbook command.   Verify the output for <strong>vne vni</strong> status, <strong>vne</strong> dynamic neighbors, mac-ip evpn route update for each L2VNI, l2fib etc. information:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>root@ubuntu:~/EVPN-Ansible# ansible-playbook verify_fabric.yml --tags &quot;overlay&quot;

PLAY [leaf, jinja2_leaf] *********************************************************************************************************************************************************************************************

TASK [Verify Overlay] ************************************************************************************************************************************************************************************************
ok: [198.18.4.104]
ok: [198.18.4.103]
ok: [198.18.4.101]

TASK [debug] *********************************************************************************************************************************************************************************************************
ok: [198.18.4.104] =&gt; {
    &quot;overlay_output.stdout_lines&quot;: [
        [
            &quot;Codes: CP - Control Plane        DP - Data Plane          &quot;,
            &quot;       UC - Unconfigured         SA - Suppress ARP        &quot;,
            &quot;       SU - Suppress Unknown Unicast&quot;,
            &quot; &quot;,
            &quot;Interface VNI      Multicast-group   State Mode Type [BD/VRF]      Flags&quot;,
            &quot;--------- -------- ----------------- ----- ---- ------------------ -----&quot;,
            &quot;nve1      50140    239.0.0.140       Up    CP   L2 [140]                  &quot;,
            &quot;nve1      50141    239.0.0.141       Up    CP   L2 [141]                  &quot;,
            &quot;nve1      50999    n/a               Up    CP   L3 [Tenant-1]&quot;
        ],
        [
            &quot;Interface Peer-IP          State LearnType Uptime   Router-Mac       &quot;,
            &quot;--------- ---------------  ----- --------- -------- -----------------&quot;,
            &quot;nve1      192.168.0.18     Up    CP        01:07:55 000c.2997.621c   &quot;,
            &quot;nve1      192.168.0.110    Up    CP        01:23:17 000c.2939.f53f&quot;
        ],
        [
            &quot;IP Route Table for VRF \&quot;Tenant-1\&quot;&quot;,
            &quot;&#39;*&#39; denotes best ucast next-hop&quot;,
            &quot;&#39;**&#39; denotes best mcast next-hop&quot;,
            &quot;&#39;[x/y]&#39; denotes [preference/metric]&quot;,
            &quot;&#39;%&lt;string&gt;&#39; in via output denotes VRF &lt;string&gt;&quot;,
            &quot;&quot;,
            &quot;172.21.140.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 22:39:01, direct&quot;,
            &quot;172.21.140.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 22:39:01, local&quot;,
            &quot;172.21.140.10/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.18%default, [200/0], 01:07:52, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a80012 encap: VXLAN&quot;,
            &quot; &quot;,
            &quot;172.21.140.11/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.110%default, [200/0], 01:23:18, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a8006e encap: VXLAN&quot;,
            &quot; &quot;,
            &quot;172.21.141.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 22:38:59, direct&quot;,
            &quot;172.21.141.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 22:38:59, local&quot;,
            &quot;172.21.141.11/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.11, Vlan141, [190/0], 07:04:08, hmm&quot;
        ],
        [
            &quot;BGP routing table information for VRF default, address family L2VPN EVPN&quot;,
            &quot;BGP table version is 458, Local Router ID is 192.168.0.11&quot;,
            &quot;Status: s-suppressed, x-deleted, S-stale, d-dampened, h-history, *-valid, &gt;-best&quot;,
            &quot;Path type: i-internal, e-external, c-confed, l-local, a-aggregate, r-redist, I-injected&quot;,
            &quot;Origin codes: i - IGP, e - EGP, ? - incomplete, | - multipath, &amp; - backup&quot;,
            &quot;&quot;,
            &quot;   Network            Next Hop            Metric     LocPrf     Weight Path&quot;,
            &quot;Route Distinguisher: 192.168.0.8:32907&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;* i                   192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;* i                   192.168.0.18                      100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.10:32907&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;* i                   192.168.0.110                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.11:32907    (L2VNI 50140)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.11:32908    (L2VNI 50141)&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100      32768 i&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100      32768 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.11:3    (L3VNI 50999)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;
        ],
        [
            &quot;Flags -(Rmac):Router MAC (Stt):Static (L):Local (R):Remote (V):vPC link &quot;,
            &quot;(Dup):Duplicate (Spl):Split (Rcv):Recv(D):Del Pending (S):Stale (C):Clear&quot;,
            &quot;(Ps):Peer Sync (Ro):Re-Originated &quot;,
            &quot;Topology    Mac Address    Prod   Flags         Seq No     Host IP         Next-Hops      &quot;,
            &quot;----------- -------------- ------ ---------- --------------- ---------------&quot;,
            &quot;140         0050.56a0.7630 BGP    --            0          172.21.140.10  192.168.0.18   &quot;,
            &quot;140         0050.56a0.b5d1 BGP    --            0          172.21.140.11  192.168.0.110  &quot;,
            &quot;141         000c.2979.f00d HMM    --            0          172.21.141.11  Local&quot;
        ]
    ]
}
ok: [198.18.4.103] =&gt; {
    &quot;overlay_output.stdout_lines&quot;: [
        [
            &quot;Codes: CP - Control Plane        DP - Data Plane          &quot;,
            &quot;       UC - Unconfigured         SA - Suppress ARP        &quot;,
            &quot;       SU - Suppress Unknown Unicast&quot;,
            &quot; &quot;,
            &quot;Interface VNI      Multicast-group   State Mode Type [BD/VRF]      Flags&quot;,
            &quot;--------- -------- ----------------- ----- ---- ------------------ -----&quot;,
            &quot;nve1      50140    239.0.0.140       Up    CP   L2 [140]                  &quot;,
            &quot;nve1      50141    239.0.0.141       Up    CP   L2 [141]                  &quot;,
            &quot;nve1      50999    n/a               Up    CP   L3 [Tenant-1]&quot;
        ],
        [
            &quot;Interface Peer-IP          State LearnType Uptime   Router-Mac       &quot;,
            &quot;--------- ---------------  ----- --------- -------- -----------------&quot;,
            &quot;nve1      192.168.0.18     Up    CP        01:07:55 000c.2997.621c   &quot;,
            &quot;nve1      192.168.0.111    Up    CP        01:23:20 000c.2951.176f&quot;
        ],
        [
            &quot;IP Route Table for VRF \&quot;Tenant-1\&quot;&quot;,
            &quot;&#39;*&#39; denotes best ucast next-hop&quot;,
            &quot;&#39;**&#39; denotes best mcast next-hop&quot;,
            &quot;&#39;[x/y]&#39; denotes [preference/metric]&quot;,
            &quot;&#39;%&lt;string&gt;&#39; in via output denotes VRF &lt;string&gt;&quot;,
            &quot;&quot;,
            &quot;172.21.140.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 01:24:28, direct&quot;,
            &quot;172.21.140.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 01:24:28, local&quot;,
            &quot;172.21.140.10/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.18%default, [200/0], 01:07:53, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a80012 encap: VXLAN&quot;,
            &quot; &quot;,
            &quot;172.21.140.11/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.11, Vlan140, [190/0], 01:23:18, hmm&quot;,
            &quot;172.21.141.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 01:24:25, direct&quot;,
            &quot;172.21.141.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 01:24:25, local&quot;,
            &quot;172.21.141.11/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.111%default, [200/0], 01:23:20, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a8006f encap: VXLAN&quot;
        ],
        [
            &quot;BGP routing table information for VRF default, address family L2VPN EVPN&quot;,
            &quot;BGP table version is 195, Local Router ID is 192.168.0.10&quot;,
            &quot;Status: s-suppressed, x-deleted, S-stale, d-dampened, h-history, *-valid, &gt;-best&quot;,
            &quot;Path type: i-internal, e-external, c-confed, l-local, a-aggregate, r-redist, I-injected&quot;,
            &quot;Origin codes: i - IGP, e - EGP, ? - incomplete, | - multipath, &amp; - backup&quot;,
            &quot;&quot;,
            &quot;   Network            Next Hop            Metric     LocPrf     Weight Path&quot;,
            &quot;Route Distinguisher: 192.168.0.8:32907&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.18                      100          0 i&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.18                      100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.10:32907    (L2VNI 50140)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100      32768 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100      32768 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.10:32908    (L2VNI 50141)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.11:32908&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.111                     100          0 i&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.111                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.10:3    (L3VNI 50999)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100          0 i&quot;
        ],
        [
            &quot;Flags -(Rmac):Router MAC (Stt):Static (L):Local (R):Remote (V):vPC link &quot;,
            &quot;(Dup):Duplicate (Spl):Split (Rcv):Recv(D):Del Pending (S):Stale (C):Clear&quot;,
            &quot;(Ps):Peer Sync (Ro):Re-Originated &quot;,
            &quot;Topology    Mac Address    Prod   Flags         Seq No     Host IP         Next-Hops      &quot;,
            &quot;----------- -------------- ------ ---------- --------------- ---------------&quot;,
            &quot;140         0050.56a0.7630 BGP    --            0          172.21.140.10  192.168.0.18   &quot;,
            &quot;140         0050.56a0.b5d1 HMM    --            0          172.21.140.11  Local          &quot;,
            &quot;141         000c.2979.f00d BGP    --            0          172.21.141.11  192.168.0.111&quot;
        ]
    ]
}
ok: [198.18.4.101] =&gt; {
    &quot;overlay_output.stdout_lines&quot;: [
        [
            &quot;Codes: CP - Control Plane        DP - Data Plane          &quot;,
            &quot;       UC - Unconfigured         SA - Suppress ARP        &quot;,
            &quot;       SU - Suppress Unknown Unicast&quot;,
            &quot; &quot;,
            &quot;Interface VNI      Multicast-group   State Mode Type [BD/VRF]      Flags&quot;,
            &quot;--------- -------- ----------------- ----- ---- ------------------ -----&quot;,
            &quot;nve1      50140    239.0.0.140       Up    CP   L2 [140]                  &quot;,
            &quot;nve1      50141    239.0.0.141       Up    CP   L2 [141]                  &quot;,
            &quot;nve1      50999    n/a               Up    CP   L3 [Tenant-1]&quot;
        ],
        [
            &quot;Interface Peer-IP          State LearnType Uptime   Router-Mac       &quot;,
            &quot;--------- ---------------  ----- --------- -------- -----------------&quot;,
            &quot;nve1      192.168.0.110    Up    CP        01:07:59 000c.2939.f53f   &quot;,
            &quot;nve1      192.168.0.111    Up    CP        01:07:59 000c.2951.176f&quot;
        ],
        [
            &quot;IP Route Table for VRF \&quot;Tenant-1\&quot;&quot;,
            &quot;&#39;*&#39; denotes best ucast next-hop&quot;,
            &quot;&#39;**&#39; denotes best mcast next-hop&quot;,
            &quot;&#39;[x/y]&#39; denotes [preference/metric]&quot;,
            &quot;&#39;%&lt;string&gt;&#39; in via output denotes VRF &lt;string&gt;&quot;,
            &quot;&quot;,
            &quot;172.21.140.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 01:24:29, direct&quot;,
            &quot;172.21.140.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 01:24:29, local&quot;,
            &quot;172.21.140.10/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.10, Vlan140, [190/0], 01:24:18, hmm&quot;,
            &quot;172.21.140.11/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.110%default, [200/0], 01:07:51, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a8006e encap: VXLAN&quot;,
            &quot; &quot;,
            &quot;172.21.141.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 01:24:25, direct&quot;,
            &quot;172.21.141.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 01:24:25, local&quot;,
            &quot;172.21.141.11/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.111%default, [200/0], 01:07:51, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a8006f encap: VXLAN&quot;
        ],
        [
            &quot;BGP routing table information for VRF default, address family L2VPN EVPN&quot;,
            &quot;BGP table version is 210, Local Router ID is 192.168.0.8&quot;,
            &quot;Status: s-suppressed, x-deleted, S-stale, d-dampened, h-history, *-valid, &gt;-best&quot;,
            &quot;Path type: i-internal, e-external, c-confed, l-local, a-aggregate, r-redist, I-injected&quot;,
            &quot;Origin codes: i - IGP, e - EGP, ? - incomplete, | - multipath, &amp; - backup&quot;,
            &quot;&quot;,
            &quot;   Network            Next Hop            Metric     LocPrf     Weight Path&quot;,
            &quot;Route Distinguisher: 192.168.0.8:32907    (L2VNI 50140)&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[0050.56a0.7630]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.18                      100      32768 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100      32768 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.8:32908    (L2VNI 50141)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.10:32907&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.110                     100          0 i&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.110                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.11:32908&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;* i                   192.168.0.111                     100          0 i&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.111                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.8:3    (L3VNI 50999)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;
        ],
        [
            &quot;Flags -(Rmac):Router MAC (Stt):Static (L):Local (R):Remote (V):vPC link &quot;,
            &quot;(Dup):Duplicate (Spl):Split (Rcv):Recv(D):Del Pending (S):Stale (C):Clear&quot;,
            &quot;(Ps):Peer Sync (Ro):Re-Originated &quot;,
            &quot;Topology    Mac Address    Prod   Flags         Seq No     Host IP         Next-Hops      &quot;,
            &quot;----------- -------------- ------ ---------- --------------- ---------------&quot;,
            &quot;140         0050.56a0.7630 HMM    --            0          172.21.140.10  Local          &quot;,
            &quot;140         0050.56a0.b5d1 BGP    --            0          172.21.140.11  192.168.0.110  &quot;,
            &quot;141         000c.2979.f00d BGP    --            0          172.21.141.11  192.168.0.111&quot;
        ]
    ]
}

PLAY RECAP ***********************************************************************************************************************************************************************************************************
198.18.4.101               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
198.18.4.103               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
198.18.4.104               : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

root@ubuntu:~/EVPN-Ansible#
</code></pre></div>
<hr />
<h3 id="step-2-install-git-and-gitlab-runner">Step 2: Install git and gitlab runner</h3>
<p>In this section you will install git and gitlab runner on Anisble node.</p>
<ul>
<li>On the <strong>Ansible node</strong> (in <strong>MTPuTTy</strong> SSH session), run the below package installation command to install git:</li>
</ul>
<div class="highlight"><pre><span></span><code>cd ~/EVPN-Ansible
apt-get install git
</code></pre></div>
<p>Below screenshot shows the execution of the command</p>
<p><img alt="" src="../pic/5-3-1.png" /></p>
<ul>
<li>On the <strong>Ansible node</strong> (in <strong>MTPuTTy</strong> SSH session), run the below <code>curl</code> command to download and run a shell script that adds the official GitLab repository required for runner installation:</li>
</ul>
<div class="highlight"><pre><span></span><code>curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash
</code></pre></div>
<p>Below screenshot shows the execution of the command</p>
<p><img alt="" src="../pic/5-3-2.png" /></p>
<ul>
<li>On the <strong>Ansible node</strong> (in <strong>MTPuTTy</strong> SSH session), run the below command to install <code>gitlab-runner</code></li>
</ul>
<div class="highlight"><pre><span></span><code>apt-get install gitlab-runner
</code></pre></div>
<p>Below screenshot shows the output of above command:</p>
<p><img alt="" src="../pic/5-3-3.png" /></p>
<h3 id="step-3-version-control-playbooks">Step 3: Version control playbooks</h3>
<p>In this step, you will use Gitlab to set version control for the playbooks.</p>
<ul>
<li>
<p>Open chrome browser and enter <strong><a href="https://gitlab.com/users/sign_in">gitlab.com/users/sign_in</a></strong> in the address bar. Sign in with <strong>Username:</strong> <code>lab.ciscolive@gmail.com</code> <strong>Password:</strong> <code>#####</code> as shown below.</p>
<p><img alt="" src="../pic/5-2-3.png" /></p>
</li>
<li>
<p>After sign in to <strong>lab.ciscolive</strong> gitlab account, click <strong>New project</strong> on the top right to build a new project as shown below:</p>
<p><img alt="" src="../pic/5-2-4.png" /></p>
</li>
<li>
<p>Select <strong>Create project</strong> to create a blank project with your assigned <strong><code>POD_{ID}</code></strong>.  Note: In the below screenshot:</p>
<ul>
<li>
<p><strong>POD_1</strong> is shown as an example - you must replace the <code>{ID}</code> with your respective pod number.  Find your assigned <strong>POD ID</strong> from table in <a href="https://ciscolivelab.github.io/LTRDCN-2765/Task1-ansible-node/">task1</a>.   </p>
</li>
<li>
<p>On this page, <strong>Select</strong> the <strong>Visibility Level</strong> to <code>Private</code></p>
</li>
<li>On this page, <strong>Click</strong> the <code>checkbox</code> to <code>Initialize repository with a README</code>  </li>
</ul>
<p><img alt="" src="../pic/5-2-5.png" /></p>
</li>
<li>
<p>On the project page, copy the project url from <strong>Clone with HTTPS</strong> as shown below. The project url will be used in next step. The project url looks like <strong>https://gitlab.com/lab.ciscolive/pod_{ID}.git</strong>.   </p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You must replace <code>{ID}</code> with your respective pod number.  </p>
</div>
<p>The screenshot below uses <strong>POD_1</strong> as example.</p>
<p><img alt="" src="../pic/5-2-6.png" /></p>
<ul>
<li>By default the <strong>main</strong> branch is protected branch.  In order to add and commit files from git command, the branch settings need to be changed to unprotected.  This change is done by cl the <strong>main</strong> branch to unprotected from project from the left pane Select <strong>Settings &gt; Repository</strong> and then on right pane Click <strong>Protected branches &gt; unprotect</strong> as shown in below screenshot:</li>
</ul>
<p><img alt="" src="../pic/5-2-7.png" /></p>
<ul>
<li>On the Ansible node (in <strong><em>MTputty</em></strong> SSH session), run the below commands to initialize git in appropriate directory:</li>
</ul>
<div class="highlight"><pre><span></span><code>cd ~/EVPN-Ansible
git init
</code></pre></div>
<p>Below screenshot shows the execution of the initialize commands in correct directory:</p>
<p><img alt="" src="../pic/5-3-5.png" /></p>
<ul>
<li>On the Ansible node, run following commands to add the remote repository as origin and verify it's result:</li>
</ul>
<div class="highlight"><pre><span></span><code>git remote add origin https://gitlab.com/lab.ciscolive/pod_{ID}.git
git remote -v
</code></pre></div>
<p>Below screenshot shows the execution of the above commands:</p>
<p><img alt="" src="../pic/5-3-5b.png" /></p>
<ul>
<li>Then to add all the files (Ansible playbooks, roles etc) to the staging area and check the status by using below commands:</li>
</ul>
<div class="highlight"><pre><span></span><code>git add .
git status
</code></pre></div>
<p>Below screenshot shows the execution of the above commands:</p>
<p><img alt="" src="../pic/5-3-5c.png" /></p>
<ul>
<li>Next, commit and push all files to <strong>main</strong> branch with below commands.  When prompted for credentials, enter the <strong>Username:</strong> <code>lab.ciscolive</code> <strong>Password:</strong> <code>#####</code></li>
</ul>
<div class="highlight"><pre><span></span><code>git checkout -b main
git commit -m &quot;initial commit&quot;
git push -f origin main
</code></pre></div>
<p>Below screenshot shows partial outputs of the commands:</p>
<p><img alt="" src="../pic/5-3-6.png" /></p>
<h3 id="step-4-add-ci-pipeline-file">Step 4: Add CI pipeline file</h3>
<p>In this step, you will create CI pepeline file for gitlab. Gitlab uses a special file named <strong>.gitlab-ci.yml</strong> for CI/CD configuration.  </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The file name starts with <strong>.</strong> and it's not a mistake.  </p>
</div>
<p>The file needs to be placed in root of the repository.  Inside the file, you will define:</p>
<ul>
<li>
<p>The stages you want run in the pipeline</p>
</li>
<li>
<p>The scripts you want run in each stage</p>
</li>
<li>
<p>The runner you want use for each script</p>
</li>
<li>
<p>How is the runner triggered for each script</p>
</li>
</ul>
<p>Pipeline file can be added from GitLab UI using pipeline file editor, or from local and push to GitLab repo using git commands.  We will use Atom to add pipeline file in this lab.</p>
<ul>
<li>
<p>Switch to <strong>"Atom"</strong> application on your remote desktop.  Right click on the folder <strong>EVPN-Ansible</strong> and Click <strong>New File</strong> to create a new file named <strong>.gitlab-ci.yml</strong></p>
</li>
<li>
<p>In the <code>.gitlab-ci.yml</code> file enter the contents shown below:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">stages</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">staging</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>

<span class="nt">verify</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EVPN</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-playbook jinja2_fabric.yml --check</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;$CI_PIPELINE_SOURCE</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&quot;push&quot;</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">$CI_COMMIT_BRANCH</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">&quot;main&quot;&#39;</span>
<span class="nt">staging</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">staging</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EVPN</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-playbook jinja2_fabric.yml</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-playbook nxos_fabric.yml</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-playbook verify_fabric.yml</span>
<span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay.txt</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">underlay.txt</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;$CI_PIPELINE_SOURCE</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&quot;push&quot;</span><span class="nv">  </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">$CI_COMMIT_BRANCH</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">&quot;main&quot;&#39;</span>
<span class="nt">deploy</span><span class="p">:</span>
<span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EVPN</span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-playbook jinja2_fabric.yml</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-playbook nxos_fabric.yml</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;$CI_PIPELINE_SOURCE</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">&quot;merge_request_event&quot;&#39;</span>
<span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
</code></pre></div>
<p>Below screenshot shows the file after added above contents on Atom</p>
<p><img alt="" src="../pic/5-3-7.png" /></p>
<ul>
<li>From <strong>Atom</strong>, go to <strong>File &gt; Save</strong> to push the new pipeline to Ansible node</li>
</ul>
<p><strong>Note</strong>, in the above pipeline file, you have configured</p>
<ul>
<li>
<p>Three stages for pipeline named <strong>test</strong>, <strong>staging</strong> and <strong>production</strong></p>
</li>
<li>
<p>In <strong>test</strong> stage, pipeline will do dry-run for the ansible playbook using a git-runner with tag <strong>EVPN</strong>. This script will be triggered by change in branch</p>
</li>
<li>
<p>In <strong>staging</strong> stage, pipeline will run playbooks to build EVPN fabric for new VNIs, also collrect show outputs files for manual verification. This scripts will be triggered after success of test stage.</p>
</li>
<li>
<p>In <strong>production</strong> stage, pipeline will run playbook to deploy EVPN fabric for new VNIs in production. This script will be triggered after merge to main branch with manual trigger.</p>
</li>
</ul>
<p>Continuing the lab steps next:</p>
<ul>
<li>Switch to Ansible node (via <strong>MTPuTTY</strong>), add the <code>.gitlab-ci.yml</code> file to staging area, and then commit &amp; push the file to remote repository (on GitLab) as shown below.  When prompted for credentials, enter the <strong>Username:</strong> <code>lab.ciscolive</code> <strong>Password:</strong> <code>#####</code>for GitLab access:</li>
</ul>
<div class="highlight"><pre><span></span><code>git add .gitlab-ci.yml
git commit -m &quot;add ci file&quot;
git push origin main
</code></pre></div>
<p>Below screenshot shows the outputs of the commands (note your git repository will be based upon your respective Pod_{ID}):</p>
<p><img alt="" src="../pic/5-3-8.png" /></p>
<h3 id="step-5-register-local-gitlab-runner">Step 5: Register local gitlab-runner</h3>
<p>In this task, you will create local gitlab runner to run pipeline jobs. You will assign <strong>EVPN</strong> as tag of the runner and register it to your project.</p>
<ul>
<li>Switch to Chrome brower with gitlab project page.  From the navigation menu on the left side, Select <strong>Settings &gt; CI/CD</strong>.  Then on the right pane for the <strong>Runners</strong>, click on <strong>Expand</strong> setting as shown in below screenshot.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Screenshot below uses POD 1 as example, find your assigned POD ID from table in task1.</p>
</div>
<p><img alt="" src="../pic/5-5-1.png" /></p>
<ul>
<li>As shown in below screenshot: under the <strong>Specific runners</strong>, note down the URL of <code>Register the runner with this URL</code>, and the <code>Registration token</code>.  Both of these will be used on next step.   Further, under <strong>Shared runners</strong>, click the toggle switch named <strong><code>Enable shared runners for this project"</code></strong> to disable the shared runners for this project.  Below screenshot shows the output once sharing has been disabled.</li>
</ul>
<p><img alt="" src="../pic/5-5-2.png" /></p>
<ul>
<li>On the Ansible node (in <strong>MTputty</strong> SSH session), register the GitLab runner by issuing the below command.  Further, when prompted provide the runner registration info as shown below:</li>
</ul>
<div class="highlight"><pre><span></span><code>gitlab-runner register
</code></pre></div>
<p><strong>Enter the GitLab instance URL:</strong>  <strong><font style=background-color:yellow>https://gitlab.com/</font></strong></p>
<p><strong>Enter the registration token:</strong>  <strong><font style=background-color:yellow> get registration token from previous step </font></strong></p>
<p><strong>Enter a description for the runner:</strong> <strong><font style=background-color:yellow>enter without change </font></strong></p>
<p><strong>Enter tags for the runner (comma-separated):</strong>  <strong><font style=background-color:yellow>EVPN </font></strong> (case sensitive)</p>
<p><strong>Enter optional maintenance note for the runner:</strong>  <strong><font style=background-color:yellow>enter without change</font></strong></p>
<p><strong>Enter an executor:</strong> <strong><font style=background-color:yellow>shell</font></strong></p>
<p>Below screenshot shows the outputs of the commands:</p>
<p><img alt="" src="../pic/5-5-3.png" /></p>
<ul>
<li>On the Ansible node (in <strong>MTputty</strong> SSH session), run command the below command to start &amp; check status of runner:</li>
</ul>
<div class="highlight"><pre><span></span><code>gitlab-runner start
gitlab-runner status
</code></pre></div>
<p>Below screenshots shown the output of above commands</p>
<p><img alt="" src="../pic/5-5-4.png" /></p>
<h3 id="step-6-add-stage-branch-and-add-new-vnis">Step 6: Add stage branch and add new VNIs</h3>
<p>In this task, you will modify the variable file to add new networks on EVPN fabric. Instead of applying the change directly to production, you will use the gitlab pipeline to do test and staging first. In order to do that, you will create new branch in your project and push the variable files to the new branch. The push will trigger gitlab-runner to execute scripts configured in pipleline file.</p>
<ul>
<li>Switch to <strong>"Atom"</strong>, Under <strong>EVPN-Ansible</strong>, scroll to <strong>roles &gt; jinja2_leaf &gt; vars</strong> and open <strong>"main.yml"</strong> file.   Enter following new VNI information under the existing <strong>L2VNI</strong> list as shown in the below screenshot:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> vlan_id</span><span class="p">:</span><span class="w"> </span><span class="nv">200</span><span class="p p-Indicator">,</span><span class="nt"> vni</span><span class="p">:</span><span class="w"> </span><span class="nv">50200</span><span class="p p-Indicator">,</span><span class="nt"> ip_add</span><span class="p">:</span><span class="w"> </span><span class="nv">172.21.200.1</span><span class="p p-Indicator">,</span><span class="nt"> mask</span><span class="p">:</span><span class="w"> </span><span class="nv">24</span><span class="p p-Indicator">,</span><span class="nt"> vlan_name</span><span class="p">:</span><span class="w"> </span><span class="nv">L2-VNI-200-Tenant1</span><span class="p p-Indicator">,</span><span class="nt"> mcast</span><span class="p">:</span><span class="w"> </span><span class="nv">239.0.0.200</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> vlan_id</span><span class="p">:</span><span class="w"> </span><span class="nv">201</span><span class="p p-Indicator">,</span><span class="nt"> vni</span><span class="p">:</span><span class="w"> </span><span class="nv">50201</span><span class="p p-Indicator">,</span><span class="nt"> ip_add</span><span class="p">:</span><span class="w"> </span><span class="nv">172.21.201.1</span><span class="p p-Indicator">,</span><span class="nt"> mask</span><span class="p">:</span><span class="w"> </span><span class="nv">24</span><span class="p p-Indicator">,</span><span class="nt"> vlan_name</span><span class="p">:</span><span class="w"> </span><span class="nv">L2-VNI-201-Tenant1</span><span class="p p-Indicator">,</span><span class="nt"> mcast</span><span class="p">:</span><span class="w"> </span><span class="nv">239.0.0.201</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w">  </span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>YAML is case and indentation sensitive, so the above vars/content must be properly added to existing file (Starting from column number 3).  </p>
</div>
<p>Below screenshot shows the file after addition of above contents on Atom:</p>
<p><img alt="" src="../pic/5-6-1.png" /></p>
<ul>
<li>
<p>From <strong>Atom</strong>, go to <strong>File &gt; Save</strong> to push the new jinja2 varilabe file to Ansible node.</p>
</li>
<li>
<p>Next, the variables will be added to Leaf role.  From <strong>"Atom"</strong>, open <strong>"main.yml"</strong> file under <strong>roles &gt; leaf &gt; vars</strong>. Enter following new VNI informtion under <strong>L2VNI</strong> as shown below</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> vlan_id</span><span class="p">:</span><span class="w"> </span><span class="nv">200</span><span class="p p-Indicator">,</span><span class="nt"> vni</span><span class="p">:</span><span class="w"> </span><span class="nv">50200</span><span class="p p-Indicator">,</span><span class="nt"> ip_add</span><span class="p">:</span><span class="w"> </span><span class="nv">172.21.200.1</span><span class="p p-Indicator">,</span><span class="nt"> mask</span><span class="p">:</span><span class="w"> </span><span class="nv">24</span><span class="p p-Indicator">,</span><span class="nt"> vlan_name</span><span class="p">:</span><span class="w"> </span><span class="nv">L2-VNI-200-Tenant1</span><span class="p p-Indicator">,</span><span class="nt"> mcast</span><span class="p">:</span><span class="w"> </span><span class="nv">239.0.0.200</span><span class="w"> </span><span class="p p-Indicator">}</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> vlan_id</span><span class="p">:</span><span class="w"> </span><span class="nv">201</span><span class="p p-Indicator">,</span><span class="nt"> vni</span><span class="p">:</span><span class="w"> </span><span class="nv">50201</span><span class="p p-Indicator">,</span><span class="nt"> ip_add</span><span class="p">:</span><span class="w"> </span><span class="nv">172.21.201.1</span><span class="p p-Indicator">,</span><span class="nt"> mask</span><span class="p">:</span><span class="w"> </span><span class="nv">24</span><span class="p p-Indicator">,</span><span class="nt"> vlan_name</span><span class="p">:</span><span class="w"> </span><span class="nv">L2-VNI-201-Tenant1</span><span class="p p-Indicator">,</span><span class="nt"> mcast</span><span class="p">:</span><span class="w"> </span><span class="nv">239.0.0.201</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w">  </span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>YAML is case and indentation sensitive, so the above vars/content must be properly added to existing file (Starting from column number 3).  Below screenshot shows the file after added above contents on Atom.</p>
</div>
<p><img alt="" src="../pic/5-6-2.png" /></p>
<ul>
<li>
<p>From <strong>Atom</strong>, go to <strong>File &gt; Save</strong> to push the new leaf variable file to Ansible node</p>
</li>
<li>
<p>On the Ansible node (in <strong>MTputty</strong> SSH session), change directory to <strong>EVPN-Ansible</strong> project folder</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>cd ~/EVPN-Ansible
</code></pre></div>
<ul>
<li>Run the following git commands to create new branch <strong>newvni</strong>, <code>commit</code> the updated variable files to that new branch and <code>push</code> to Gitlab project:</li>
</ul>
<div class="highlight"><pre><span></span><code>git branch -m newvni
git add .
git commit -m &quot;newvni&quot;
git push -f origin newvni
</code></pre></div>
<p>When prompted, Use <strong>username:</strong> of <code>lab.ciscolive</code> and <strong>password:</strong> <code>#####</code> for gitlab access</p>
<p><img alt="" src="../pic/5-6-3.png" /></p>
<h3 id="step-7-review-pipeline-testing-and-staging-results">Step 7: Review pipeline testing and staging results</h3>
<p>In this task, you will review the script results from pipeline. The <strong>git push</strong> command in previous task triggered pipeline test and staging stage.</p>
<ul>
<li>Switch to Chrome brower with GitLab project page.  On the navigation menu on left side, select <strong>CI/CD &gt; Pipelines</strong>  as shown below:</li>
</ul>
<p><img alt="" src="../pic/5-7-1.png" /></p>
<ul>
<li>Wait for the jobs finish, you can also access the runner console by clicking the pipeline stage under <strong>Stages</strong> and view the Job details as shown below:</li>
</ul>
<p><img alt="" src="../pic/5-7-2.png" /></p>
<ul>
<li>After both pipeline stags are passed, you can verify the staging result from the stage artifacts. Click the the three vertical dots (<strong>...</strong>) on the right most of the <code>pipeline</code> and <strong>Download artifacts</strong> as shown below.</li>
</ul>
<p><img alt="" src="../pic/5-7-3.png" /></p>
<ul>
<li>
<p>Unzip the downloaded <strong>artifacts.zip</strong> on your remote desktop, and you will see <strong>overlay.txt</strong> and <strong>underlay.txt</strong> files - these are the outputs from the ansible playbook.</p>
</li>
<li>
<p>Review the overlay show outputs and you can see new vni 50200 and 50201 are deployed on staging environment as shown below:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>-   - &#39;Codes: CP - Control Plane        DP - Data Plane          &#39;
    - &#39;       UC - Unconfigured         SA - Suppress ARP        &#39;
    - &#39;       SU - Suppress Unknown Unicast&#39;
    - &#39; &#39;
    - Interface VNI      Multicast-group   State Mode Type [BD/VRF]      Flags
    - &#39;--------- -------- ----------------- ----- ---- ------------------ -----&#39;
    - &#39;nve1      50140    239.0.0.140       Up    CP   L2 [140]                  &#39;
    - &#39;nve1      50141    239.0.0.141       Up    CP   L2 [141]                  &#39;
    - &#39;nve1      50200    239.0.0.200       Up    CP   L2 [200]                  &#39;
    - &#39;nve1      50201    239.0.0.201       Up    CP   L2 [201]                  &#39;
    - nve1      50999    n/a               Up    CP   L3 [Tenant-1]
-   - &#39;&#39;
-   - IP Route Table for VRF &quot;Tenant-1&quot;
    - &#39;&#39;&#39;*&#39;&#39; denotes best ucast next-hop&#39;
    - &#39;&#39;&#39;**&#39;&#39; denotes best mcast next-hop&#39;
    - &#39;&#39;&#39;[x/y]&#39;&#39; denotes [preference/metric]&#39;
    - &#39;&#39;&#39;%&lt;string&gt;&#39;&#39; in via output denotes VRF &lt;string&gt;&#39;
    - &#39;&#39;
    - &#39;172.21.140.0/24, ubest/mbest: 1/0, attached&#39;
    - &#39;    *via 172.21.140.1, Vlan140, [0/0], 17:56:06, direct&#39;
    - &#39;172.21.140.1/32, ubest/mbest: 1/0, attached&#39;
    - &#39;    *via 172.21.140.1, Vlan140, [0/0], 17:56:06, local&#39;
    - &#39;172.21.141.0/24, ubest/mbest: 1/0, attached&#39;
    - &#39;    *via 172.21.141.1, Vlan141, [0/0], 17:56:05, direct&#39;
    - &#39;172.21.141.1/32, ubest/mbest: 1/0, attached&#39;
    - &#39;    *via 172.21.141.1, Vlan141, [0/0], 17:56:05, local&#39;
    - &#39;172.21.200.0/24, ubest/mbest: 1/0, attached&#39;
    - &#39;    *via 172.21.200.1, Vlan200, [0/0], 17:56:04, direct&#39;
    - &#39;172.21.200.1/32, ubest/mbest: 1/0, attached&#39;
    - &#39;    *via 172.21.200.1, Vlan200, [0/0], 17:56:04, local&#39;
    - &#39;172.21.201.0/24, ubest/mbest: 1/0, attached&#39;
    - &#39;    *via 172.21.201.1, Vlan201, [0/0], 17:56:04, direct&#39;
    - &#39;172.21.201.1/32, ubest/mbest: 1/0, attached&#39;
    - &#39;    *via 172.21.201.1, Vlan201, [0/0], 17:56:04, local&#39;
-   - &#39;&#39;
-   - &#39;Flags -(Rmac):Router MAC (Stt):Static (L):Local (R):Remote (V):vPC link &#39;
    - (Dup):Duplicate (Spl):Split (Rcv):Recv(D):Del Pending (S):Stale (C):Clear
    - &#39;(Ps):Peer Sync (Ro):Re-Originated &#39;
    - &#39;Topology    Mac Address    Prod   Flags         Seq No     Host IP         Next-Hops      &#39;
    - &#39;----------- -------------- ------ ---------- --------------- ---------------&#39;
</code></pre></div>
<h3 id="step-8-merge-to-main-branch">Step 8: Merge to main branch</h3>
<p>After reviewing the test result from staging environment, you confirmed the new NVIs are deployed properly, you will merge the <strong>newvni</strong> branch to <strong>main</strong> branch and deploy the new VNIs on production environment.</p>
<p>Typically in real world there will (should!) be separate environments for staging and production.  In this lab, we are using same inventory for staging and production environments for simplicity purposes.  So once the merge is done then the changes can be rolled out to production (by applying ansible playbooks)</p>
<ul>
<li>Switch to Chrome browser with gitlab project page for your respective <code>pod_{ID}</code> <strong>repository</strong>.  Select <strong>Merge requests</strong> from navigation menu on the left, and select <strong>New merge request</strong> as shown below.</li>
</ul>
<p><img alt="" src="../pic/5-8-1.png" /></p>
<ul>
<li>Under the <code>Source branch</code> section, from the <code>Select source branch</code> drop down menu select <strong>newvni</strong> branch.  Further, on the <code>Target branch</code> section, under <code>Select target branch</code> drop down menu make sure that <strong>main</strong> branch is selected as shown in the screenshot below.  </li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Below screenshot uses POD 1 as example, you must use your assigned POD ID from table in task1.</p>
</div>
<p><img alt="" src="../pic/5-8-2.png" /></p>
<ul>
<li>
<p>Next, click <strong>Compare branches and continue</strong> on the above page</p>
</li>
<li>
<p>On the next page, give a <strong>Title</strong> for the merge request as <strong>newvni Pod_<code>#</code></strong> (replace <code>#</code> with your respective Pod ID), leave everything else as default and click <strong>Create merge request</strong></p>
</li>
<li>
<p>On the merge request, <strong>un-check</strong> the <strong>Delete source branch</strong> after merge option.  You may add Edit merger commit message. And after you have reviewed the merge request, click the <strong>Merge</strong> button as shown in the screenshot below:</p>
</li>
</ul>
<p><img alt="" src="../pic/5-8-3.png" /></p>
<ul>
<li>
<p>As per the CI pipeline file (named: <strong>.gitlab-ci.yml</strong> ) the <code>rules</code> was configured for <strong>manual</strong> trigger for production deployment, hence the job for deploying production will not be triggered automatically.  Instead, you will manually kickoff the production deployment job on pipeline.</p>
</li>
<li>
<p>Switch to Chrome brower with gitlab project page, select <strong>CI/CD &gt; Pipelines</strong> from navigation menu on the left</p>
</li>
<li>
<p>Deploy the newvni on production enviroment by selecting <strong>deploy</strong> on the pipeline job from previous merger request as shown in the screenshot below:</p>
</li>
</ul>
<p><img alt="" src="../pic/5-8-4.png" /></p>
<ul>
<li>Wait for the job finish, you can also access the runner console by clicking the pipeline stage under <strong>Stages</strong> as shown below:</li>
</ul>
<p><img alt="" src="../pic/5-8-5.png" /></p>
<h1 id="congratulation-you-have-completed-vxlan-fabric-and-netdevops-automation-lab">Congratulation! You have completed VXLAN Fabric and NetDevOps automation Lab.</h1>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../task4-vxlan-nxos/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Task 4 - Config switches using Ansible NXOS modules" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Task 4 - Config switches using Ansible NXOS modules
              </div>
            </div>
          </a>
        
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.top", "navigation.footer", "content.code.annotate"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fac441b0.min.js"></script>
      
    
  </body>
</html>