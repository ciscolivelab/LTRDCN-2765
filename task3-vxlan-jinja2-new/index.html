
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../task2-first-ansible/">
      
      
        <link rel="next" href="../task4-vxlan-nxos/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.11">
    
    
      
        <title>Task 3 - Use of Jinja2 templates with Ansible Playbook - Cisco Live 2023 LTRDCN-2765</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.85bb2934.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#step-1-install-jinja2" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cisco Live 2023 LTRDCN-2765" class="md-header__button md-logo" aria-label="Cisco Live 2023 LTRDCN-2765" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cisco Live 2023 LTRDCN-2765
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Task 3 - Use of Jinja2 templates with Ansible Playbook
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ciscolivelab/LTRDCN-2765" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../intro/" class="md-tabs__link">
      Introduction
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../Task1-ansible-node0/" class="md-tabs__link">
      Task 1 - Prepare Ansible node
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../task2-first-ansible/" class="md-tabs__link">
      Task 2 - First Simple Ansible Playbook
    </a>
  </li>

      
        
  
  
    
  


  <li class="md-tabs__item">
    <a href="./" class="md-tabs__link md-tabs__link--active">
      Task 3 - Use of Jinja2 templates with Ansible Playbook
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../task4-vxlan-nxos/" class="md-tabs__link">
      Task 4 - Config switches using Ansible NXOS modules
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../task5-day2-pipeline0/" class="md-tabs__link">
      Task 5 - Day 2 Opertions with CI Pipeline
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cisco Live 2023 LTRDCN-2765" class="md-nav__button md-logo" aria-label="Cisco Live 2023 LTRDCN-2765" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Cisco Live 2023 LTRDCN-2765
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ciscolivelab/LTRDCN-2765" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Task1-ansible-node0/" class="md-nav__link">
        Task 1 - Prepare Ansible node
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../task2-first-ansible/" class="md-nav__link">
        Task 2 - First Simple Ansible Playbook
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Task 3 - Use of Jinja2 templates with Ansible Playbook
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Task 3 - Use of Jinja2 templates with Ansible Playbook
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-install-jinja2" class="md-nav__link">
    Step 1: Install jinja2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-playbook-for-jinja2-spine" class="md-nav__link">
    Step 2: Playbook for jinja2 Spine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-create-new-roles-and-vars" class="md-nav__link">
    Step 3: Create new roles and vars
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-create-variable-file-for-jina2_spine-role" class="md-nav__link">
    Step 4: Create variable file for “jina2_spine” role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-create-jinja2-template-for-spine-role" class="md-nav__link">
    Step 5: Create Jinja2 template for spine role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-create-playbook-for-jinja2_spine-role" class="md-nav__link">
    Step 6: Create playbook for jinja2_spine role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-run-jinja2_fabric-playbook" class="md-nav__link">
    Step 7: Run Jinja2_fabric playbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-modify-playbook-for-leaf" class="md-nav__link">
    Step 8: Modify playbook for Leaf
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-9-variable-file-for-jinja2_leaf-role" class="md-nav__link">
    Step 9: Variable file for jinja2_leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-10-jinja2-template-for-leaf-role" class="md-nav__link">
    Step 10: Jinja2 template for leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-11-create-playbook-for-jinja2_leaf-role" class="md-nav__link">
    Step 11: Create playbook for jinja2_leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-12-run-jinja2_fabric-playbook" class="md-nav__link">
    Step 12: Run Jinja2_fabric playbook
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../task4-vxlan-nxos/" class="md-nav__link">
        Task 4 - Config switches using Ansible NXOS modules
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../task5-day2-pipeline0/" class="md-nav__link">
        Task 5 - Day 2 Opertions with CI Pipeline
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-install-jinja2" class="md-nav__link">
    Step 1: Install jinja2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-playbook-for-jinja2-spine" class="md-nav__link">
    Step 2: Playbook for jinja2 Spine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-create-new-roles-and-vars" class="md-nav__link">
    Step 3: Create new roles and vars
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-create-variable-file-for-jina2_spine-role" class="md-nav__link">
    Step 4: Create variable file for “jina2_spine” role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-create-jinja2-template-for-spine-role" class="md-nav__link">
    Step 5: Create Jinja2 template for spine role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-create-playbook-for-jinja2_spine-role" class="md-nav__link">
    Step 6: Create playbook for jinja2_spine role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-run-jinja2_fabric-playbook" class="md-nav__link">
    Step 7: Run Jinja2_fabric playbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-modify-playbook-for-leaf" class="md-nav__link">
    Step 8: Modify playbook for Leaf
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-9-variable-file-for-jinja2_leaf-role" class="md-nav__link">
    Step 9: Variable file for jinja2_leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-10-jinja2-template-for-leaf-role" class="md-nav__link">
    Step 10: Jinja2 template for leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-11-create-playbook-for-jinja2_leaf-role" class="md-nav__link">
    Step 11: Create playbook for jinja2_leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-12-run-jinja2_fabric-playbook" class="md-nav__link">
    Step 12: Run Jinja2_fabric playbook
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Task 3 - Use of Jinja2 templates with Ansible Playbook</h1>

<p>In this section, we will use Jinja2 templating engine to create templates for spine and leaf switches.  Use of Jinja template provide flexibility and agility.  Jinja2 template will appear similar to the NXOS configurations. We abstract the variables out of the configuration and use simple <code>for</code> loop to feed variables into the template.  This shows the power of using Jinja2 templating engine.</p>
<p>In this task, you will configure VXLAN fabric using this Jinja2 templates for one leaf (leaf-4) and one Spine (spine2) switch.</p>
<p><img alt="" src="../pic/3-0-1-new.png" /></p>
<hr />
<h3 id="step-1-install-jinja2">Step 1: Install jinja2</h3>
<ul>
<li>On the Ansible node, install jinja2 using <code>pip install jinja2</code> command below.  If it is already installed, we will get the message “requirement is satisfied”:</li>
</ul>
<div class="highlight"><pre><span></span><code>pip install jinja2
</code></pre></div>
<p>Below screenshot shows the output of above command:</p>
<p><img alt="" src="../pic/3-1-1-new.png" /></p>
<hr />
<h3 id="step-2-playbook-for-jinja2-spine">Step 2: Playbook for jinja2 Spine</h3>
<p>In this step, we will use Jina2 template and Ansible to provision the VXLAN Fabric.</p>
<ul>
<li>
<p>Switch to <strong>Atom</strong>, then <strong>Right Click</strong> on the folder <code>EVPN-Ansible</code> and <strong>Click</strong> <code>New File</code> to create a new playbook named <code>jinja2_fabric.yml</code> as shown below</p>
<p><img alt="" src="../pic/3-2-1.png" /></p>
</li>
<li>
<p>Name the new file <code>jinja2_fabric.yml</code> and hit <strong>enter</strong> as shown below. It will create this new file:</p>
</li>
</ul>
<p><img alt="" src="../pic/3-2-1a.png" /></p>
<ul>
<li>
<p>Also, on the lower bar of the <strong>Atom</strong>, verify that the language/grammar of <strong>YAML</strong> is selected instead of default "<strong>Plain Text</strong>".  If <strong>YAML</strong> is not selected, then you should <strong>choose</strong> it from the listed options.</p>
</li>
<li>
<p>Now enter (<strong>copy</strong> and <strong>paste</strong>) below data in this playbook:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jinja2_spine</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jinja2_spine</span>
</code></pre></div>
<p>The contents of the <strong>jinja2_fabric.yml</strong> file should look like below screenshot:</p>
<p><img alt="" src="../pic/3-2-2-new.png" /></p>
<ul>
<li>
<p>On <strong>Atom</strong>, you should <strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package</p>
</li>
<li>
<p>On the <strong>MTPuTTy</strong>, go back to the <strong>ssh</strong> session of the Ansible Server node (198.18.134.150)</p>
</li>
<li>
<p>On Ansible server node (198.18.134.150), <strong>verify</strong> that the (below highlighted) 2 groups named  <code>jinja2_spine</code> and <code>jinja2_leaf</code> exists in the inventory file name "<strong>hosts</strong>" (under EVPN-Ansible directory) exists by issuing below commands:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>cd /root/EVPN-Ansible
more hosts
</code></pre></div>
<p>Below screenshot confirms the ouptut and appropriate IP addresses of above command:</p>
<p><img alt="" src="../pic/3-2-3.png" /></p>
<hr />
<h3 id="step-3-create-new-roles-and-vars">Step 3: Create new roles and vars</h3>
<p>In this section, we will create two new roles for provisioning Fabric with Jina2 template.</p>
<ul>
<li>On the <strong>MTPuTTy</strong>, go back to Ansible Server node (198.18.134.150).  Switch to ‘<strong>roles</strong>’ directory and then <strong>create</strong> <code>‘jinja2_spine’</code> and <code>‘jinja2_leaf’</code> roles using <code>ansible-galaxy init</code> as per below commands:</li>
</ul>
<div class="highlight"><pre><span></span><code>cd ~/EVPN-Ansible/
cd roles/
ansible-galaxy init jinja2_spine &amp;&amp; ansible-galaxy init jinja2_leaf
</code></pre></div>
<ul>
<li>
<p>Below screenshot shows the output of above command:</p>
<p><img alt="" src="../pic/3-3-1.png" /></p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>‘<strong>ansible-galaxy</strong>’ will initialize the role structure and create necessary folders with default name like ‘tasks’, ‘template’, ‘vars’ etc.</p>
</div>
<ul>
<li><strong>change directory</strong> path to <code>EVPN-Ansible/roles/jinja2_spine</code> and check the content of local directory (<code>ls</code>) as per below commands:</li>
</ul>
<div class="highlight"><pre><span></span><code>cd ~/EVPN-Ansible/roles/jinja2_spine/
ls
</code></pre></div>
<ul>
<li>
<p>Below screenshot shows the output of above file.  Note that various directories including tasks, templates, vars exists.  We will use these in later steps</p>
<p><img alt="" src="../pic/3-3-2.png" /></p>
</li>
</ul>
<p>Next:</p>
<ul>
<li><strong>Create</strong> empty jinja2 template files for spine and leaf under templates folder for each role by running below commands:</li>
</ul>
<div class="highlight"><pre><span></span><code>cd ~/EVPN-Ansible/roles
touch jinja2_spine/templates/spine.j2
touch jinja2_leaf/templates/leaf.j2
</code></pre></div>
<ul>
<li>Switch to “<strong>Atom</strong>” and <em>sync</em> the new created folders between Ansible node and Remote desktop by pressing <strong>Right Click</strong> on the folder <code>EVPN-Ansible</code>, then <strong>Click</strong> <code>Remote Sync</code>, and <strong>Select</strong> <code>Download Folder</code> as shown in below screenshot:</li>
</ul>
<p><img alt="" src="../pic/3-3-3.png" /></p>
<ul>
<li>Once the download is complete, you should see the new folder (such as <code>roles</code>) and all files appear on <strong>Atom</strong> as well.</li>
</ul>
<hr />
<h3 id="step-4-create-variable-file-for-jina2_spine-role">Step 4: Create variable file for “jina2_spine” role</h3>
<p>“<strong>ansible-galaxy</strong>” automatically creates empty “<strong>main.yml</strong>” file under “<strong>vars</strong>” folder. We can use “<strong>Atom</strong>” to edit this <code>main.yml</code> file to include the variables that will be used in jinja2 template.</p>
<ul>
<li>
<p>Switch to <strong>Atom</strong>, then open up the project folder <code>EVPN-Ansible</code> from the left pane and <strong>Open</strong> <code>main.yml</code> file under “<strong>roles/jinja2_spine/vars/</strong>” as shown below:</p>
<p><img alt="" src="../pic/3-4-1.png" /></p>
</li>
<li>
<p>use “<strong>Atom</strong>” to edit the “<strong>main.yml</strong>” file to include the below variables that will be used in jinja2 template.  You can <strong>copy</strong> and <strong>paste</strong> all of the below to replace any existing content into <code>main.yml</code> file.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As per steps in previous tasks, be careful with content since its space sensitive.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="c1"># vars file for jinja2_spine</span>
<span class="w">  </span><span class="nt">asn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65000</span>
<span class="w">  </span><span class="nt">bgp_neighbors</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">remote_as</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65000</span>
<span class="w">    </span><span class="nt">neighbor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.8</span>
<span class="w">    </span><span class="nt">update_source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Loopback0</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">remote_as</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65000</span>
<span class="w">    </span><span class="nt">neighbor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.10</span>
<span class="w">    </span><span class="nt">update_source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Loopback0</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">remote_as</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65000</span>
<span class="w">    </span><span class="nt">neighbor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.11</span>
<span class="w">    </span><span class="nt">update_source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Loopback0</span>
<span class="w">  </span><span class="nt">L3_interfaces</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ethernet 1/1</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ethernet 1/2</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ethernet 1/3</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ethernet 1/4</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">loopback 0</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">loopback 1</span>
<span class="w">  </span><span class="nt">s1_loopback</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.6</span>
<span class="w">  </span><span class="nt">s2_loopback</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.7</span>
</code></pre></div>
<ul>
<li>
<p>Contents of the ‘<strong>main.yml</strong>’ file should look like below screenshot:</p>
<p><img alt="" src="../pic/3-4-2.png" /></p>
</li>
<li>
<p><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package.</p>
</li>
</ul>
<hr />
<h3 id="step-5-create-jinja2-template-for-spine-role">Step 5: Create Jinja2 template for spine role</h3>
<ul>
<li>On <strong>Atom</strong>, <strong>Select</strong> the project folder <code>EVPN-Ansible</code> from the left pane.  Then under “<strong>roles/jinja2_spine/templates</strong>”,  <strong>Open</strong> <code>spine.j2</code> file as shown in below screenshot:</li>
</ul>
<p><img alt="" src="../pic/3-5-0.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the file does not appear on the ATOM, then go ahead and then execute steps outlined <a href="https://ciscolivelab.github.io/LTRDCN-2765/missing_file_spine/">on this page</a> to get it sync.  If the <code>spine.j2</code> file appears in above folder then can proceed below**</p>
</div>
<ul>
<li>use “<strong>Atom</strong>” to edit the “<strong>spine.j2</strong>” file for jinja2 template.  You can <strong>copy</strong> and <strong>paste</strong> all of the below content into <code>spine.j2</code> file.  </li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As per steps in previous tasks, be careful with content since its space sensitive.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">feature bgp</span>
<span class="l l-Scalar l-Scalar-Plain">feature nv overlay</span>
<span class="l l-Scalar l-Scalar-Plain">feature vn-segment-vlan-based</span>
<span class="l l-Scalar l-Scalar-Plain">nv overlay evpn</span>
<span class="l l-Scalar l-Scalar-Plain">feature pim</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">router bgp {{ asn }}</span>
<span class="l l-Scalar l-Scalar-Plain">router-id {{ router_id }}</span>
<span class="l l-Scalar l-Scalar-Plain">address-family ipv4 unicast</span>
<span class="l l-Scalar l-Scalar-Plain">address-family l2vpn evpn</span>
<span class="l l-Scalar l-Scalar-Plain">retain route-target all</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">#for loop to configure bgp neighbor for each leaf</span>
<span class="l l-Scalar l-Scalar-Plain">{% for neighbor in bgp_neighbors %}</span>
<span class="l l-Scalar l-Scalar-Plain">neighbor {{ neighbor[&#39;neighbor&#39;] }}</span>
<span class="l l-Scalar l-Scalar-Plain">remote-as {{neighbor[&#39;remote_as&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">update-source {{neighbor[&#39;update_source&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">address-family ipv4 unicast</span>
<span class="l l-Scalar l-Scalar-Plain">send-community both</span>
<span class="l l-Scalar l-Scalar-Plain">route-reflector-client</span>
<span class="l l-Scalar l-Scalar-Plain">address-family l2vpn evpn</span>
<span class="l l-Scalar l-Scalar-Plain">send-community both</span>
<span class="l l-Scalar l-Scalar-Plain">route-reflector-client</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
<span class="l l-Scalar l-Scalar-Plain">interface loopback 1</span>
<span class="l l-Scalar l-Scalar-Plain">ip address {{loopback1}}/32</span>
<span class="l l-Scalar l-Scalar-Plain">ip pim sparse-mode</span>
<span class="l l-Scalar l-Scalar-Plain">ip router ospf 1 area 0.0.0.0</span>

<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">ip pim rp-address {{loopback1}}</span>
<span class="l l-Scalar l-Scalar-Plain">ip pim anycast-rp {{loopback1}} {{s1_loopback}}</span>
<span class="l l-Scalar l-Scalar-Plain">ip pim anycast-rp {{loopback1}} {{s2_loopback}}</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">#for loop to enable pim on link to each leaf</span>
<span class="l l-Scalar l-Scalar-Plain">{% for interface in L3_interfaces %}</span>
<span class="l l-Scalar l-Scalar-Plain">interface {{interface[&#39;interface&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">ip pim sparse-mode</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
</code></pre></div>
<ul>
<li>
<p>Next on <strong>Atom</strong>, <strong>Click</strong> on <code>File</code> and then <code>Save</code> to push template file to Ansible node.</p>
</li>
<li>
<p>You can verify that updated file content is on Ansible server (198.18.134.150) using your SSH session by issuing below commands:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>cd /root/EVPN-Ansible/roles/jinja2_spine/templates
more spine.j2
</code></pre></div>
<p>Partial output of above command is shown in below screenshot confirming the content:</p>
<p><img alt="" src="../pic/3-5-6.png" /></p>
<hr />
<h3 id="step-6-create-playbook-for-jinja2_spine-role">Step 6: Create playbook for jinja2_spine role</h3>
<p>The playbook for <code>jinja2_spine</code> roles has two tasks.</p>
<ul>
<li>First play in the task uses ansible "<strong>template</strong>" module to generate configuration file based on jinja2 template created in last step.  The configuration file is saved in “<strong>file</strong>” folder.</li>
<li>Second play in the task pushes the configuration to switch by using ansible "<strong>cisco.nxos.nxos_config</strong>" module.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>“<strong>ansible-galaxy</strong>” automatically creates empty “<strong>main.yml</strong>” file under “<strong>tasks</strong>” folder.  We are going to use “<strong>Atom</strong>” to edit the <strong>main.yml</strong> file.</p>
</div>
<ul>
<li>On <strong>Atom</strong>, open up the project folder <code>EVPN-Ansible</code>.  Then <strong>open</strong> <code>main.yml</code> file under <code>roles/jinja2_spine/tasks/</code> to include below content:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="c1"># tasks file for jinja2_spine</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Generate Spine Config</span>
<span class="w">    </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">src=spine.j2 dest=roles/jinja2_spine/files/{{inventory_hostname}}.cfg</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Push Spine Config</span>
<span class="w">    </span><span class="nt">cisco.nxos.nxos_config</span><span class="p">:</span>
<span class="w">      </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">roles/jinja2_spine/files/{{inventory_hostname}}.cfg</span>
<span class="w">      </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">none</span>
</code></pre></div>
<p>Contents of the ‘<strong>main.yml</strong>’ file should look like below:</p>
<p><img alt="" src="../pic/3-6-1.png" /></p>
<ul>
<li><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also scp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package</li>
</ul>
<p>In the above <code>tasks/main.yml</code> file, ansible module named “<strong>cisco.nxos.nxos_config</strong>” is used.  This module performs below activities:</p>
<ul>
<li>It uses source path of the file (“<strong><em>src</em></strong>”) that contains the configuration or configuration template to load into spine.</li>
<li>Since “<strong><em>match</em></strong>” option is set to <em>none</em>, hence the module will not attempt to compare the source configuration with the running configuration on the remote device.</li>
</ul>
<hr />
<h3 id="step-7-run-jinja2_fabric-playbook">Step 7: Run Jinja2_fabric playbook</h3>
<p>In this section you will run the playbook created in step 2 (in this task 3).  The execution of this playbook will generate configuration file for Spine-2 switch from the template.  Further, The playbook will also push the configuration file to Spine-2 switches.</p>
<ul>
<li>Run the ansible playbook by going to folder EVPN-Ansible and executing the below commands:</li>
</ul>
<div class="highlight"><pre><span></span><code>cd ~/EVPN-Ansible/
ansible-playbook jinja2_fabric.yml
</code></pre></div>
<p><strong>Note:</strong> You can ignore the <code>[WARNING]</code> messages for <code>ansible-pylibssh</code> and <code>timeout for nxos_facts</code>.
<strong>Note:</strong> You can ignore the <code>timeout for nxos_facts</code> message.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It will take few minutes to push configuration</p>
</div>
<p>Below screenshot shows the execution of above playbook:</p>
<p><img alt="" src="../pic/3-7-1b.png" /></p>
<p>To verify the execution of this playbook, you can:</p>
<ul>
<li>
<p><strong>Login/SSH</strong> to <strong>Spine-2</strong> switch using <strong>MTPuTTy</strong> to verify that configuration has been pushed by double clicking the Spine-2 icon in the left pane on MTPuTTy.    <em>If prompted, then login with credentials of <code>admin</code> and <code>C1sco12345</code></em></p>
</li>
<li>
<p><strong>Execute</strong> below command on <strong>Spine-2</strong> switch to confirm the configurations have been provisioned:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>show run bgp
</code></pre></div>
<p>The execution of this command is captured in below screenshot:</p>
<p><img alt="" src="../pic/3-7-2-new.png" /></p>
<hr />
<h3 id="step-8-modify-playbook-for-leaf">Step 8: Modify playbook for Leaf</h3>
<p>In this section, we will use Jina2 template and Ansible to provision the VXLAN Fabric on leaf-4.   We are going to add jinja2_leaf this time in the hosts list to the already created playbook in step 2.</p>
<ul>
<li>
<p>Switch to “<strong>Atom</strong>”, then <strong>click</strong> on the folder <code>EVPN-Ansible</code>, select the existing playbook <code>jinja2_fabric.yml</code> file for a role for leaf (named jinja2_leaf)</p>
</li>
<li>
<p><strong>Add</strong> (i.e., <strong>Copy</strong> and <strong>Paste</strong>) the below content at the end of existing file i.e., add the below content to existing content in this file.  </p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Do not overwrite existing content of this file.  You must add below content to this file.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jinja2_leaf</span>
<span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jinja2_leaf</span>
</code></pre></div>
<p>Below screenshot shows the contents of <strong>jinja2_fabric.yml</strong> file in Atom after adding the above configs:</p>
<p><img alt="" src="../pic/3-8-1.png" /></p>
<ul>
<li><strong>Click</strong> <code>File</code> and <code>Save</code> on <strong>Atom</strong>. This will save the playbook, and also scp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package</li>
</ul>
<hr />
<h3 id="step-9-variable-file-for-jinja2_leaf-role">Step 9: Variable file for jinja2_leaf role</h3>
<ul>
<li>On <strong>Atom</strong>, open up the project folder <code>EVPN-Ansible</code> and edit <code>main.yml</code> file under <code>roles/jinja2_leaf/vars/</code> to include following:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="c1"># vars file for jinja2_leaf</span>
<span class="w">  </span><span class="nt">asn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65000</span>
<span class="w">  </span><span class="nt">bgp_neighbors</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">remote_as</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65000</span>
<span class="w">     </span><span class="nt">neighbor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.6</span>
<span class="w">     </span><span class="nt">update_source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Loopback0</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">remote_as</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65000</span>
<span class="w">     </span><span class="nt">neighbor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.7</span>
<span class="w">     </span><span class="nt">update_source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Loopback0</span>
<span class="w">  </span><span class="nt">rp_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.0.100</span>
<span class="w">  </span><span class="nt">L3_interfaces</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ethernet 1/1</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ethernet 1/2</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">loopback 0</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">loopback 1</span>
<span class="w">  </span><span class="nt">L2VNI</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">vlan_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">140</span>
<span class="w">     </span><span class="nt">vni</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50140</span>
<span class="w">     </span><span class="nt">ip_add</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.21.140.1</span>
<span class="w">     </span><span class="nt">mask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24</span>
<span class="w">     </span><span class="nt">vlan_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">L2-VNI-140-Tenant1</span>
<span class="w">     </span><span class="nt">mcast</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">239.0.0.140</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">vlan_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">141</span>
<span class="w">     </span><span class="nt">vni</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50141</span>
<span class="w">     </span><span class="nt">ip_add</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.21.141.1</span>
<span class="w">     </span><span class="nt">mask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24</span>
<span class="w">     </span><span class="nt">vlan_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">L2-VNI-141-Tenant1</span>
<span class="w">     </span><span class="nt">mcast</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">239.0.0.141</span>
<span class="w">  </span><span class="nt">L3VNI</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w">  </span><span class="nt">vlan_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">999</span>
<span class="w">     </span><span class="nt">vlan_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">L3-VNI-999-Tenant1</span>
<span class="w">     </span><span class="nt">vni</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50999</span>
</code></pre></div>
<p>Below screenshot shows the contents of <code>roles/jinja2_leaf/vars/main.yml</code> file in Atom:</p>
<p><img alt="" src="../pic/3-9-1.png" /></p>
<ul>
<li><strong>Click</strong> <code>File</code> and <code>Save</code> on <strong>Atom</strong>. This will save the playbook, and also scp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package.</li>
</ul>
<hr />
<h3 id="step-10-jinja2-template-for-leaf-role">Step 10: Jinja2 template for leaf role</h3>
<ul>
<li>On <strong>Atom</strong>, you can <strong>Select</strong> the project folder <code>EVPN-Ansible</code> and <strong>open</strong> <code>leaf.j2</code> file under <code>roles/jinja2_leaf/templates/</code></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the file does not appear on the ATOM, then go ahead and execute the steps <a href="https://ciscolivelab.github.io/LTRDCN-2765/missing_file_leaf/">on this page</a> to get it sync.  If the <code>leaf.j2</code> file appears in above folder then you can proceed with below steps further.</p>
</div>
<ul>
<li>On “<strong>Atom</strong>”, edit this <code>leaf.j2</code> file for jinja2 template by <strong>copy</strong> and <strong>paste</strong> all of the below content in it.  !!! Note
    As per steps in previous tasks, be careful with content since its space sensitive.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">feature bgp</span>
<span class="l l-Scalar l-Scalar-Plain">feature nv overlay</span>
<span class="l l-Scalar l-Scalar-Plain">feature vn-segment-vlan-based</span>
<span class="l l-Scalar l-Scalar-Plain">nv overlay evpn</span>
<span class="l l-Scalar l-Scalar-Plain">feature pim</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">ip pim rp-address {{rp_address}}</span>
<span class="l l-Scalar l-Scalar-Plain">spanning-tree vlan 1,140,141,999 priority 4096</span>
<span class="l l-Scalar l-Scalar-Plain">{% for L2VNI in L2VNI %}</span>
<span class="l l-Scalar l-Scalar-Plain">vlan {{L2VNI[&#39;vlan_id&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">name {{L2VNI[&#39;vlan_name&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">vn-segment {{L2VNI[&#39;vni&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>

<span class="l l-Scalar l-Scalar-Plain">{% for L3VNI in L3VNI %}</span>
<span class="l l-Scalar l-Scalar-Plain">vlan {{L3VNI[&#39;vlan_id&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">vn-segment {{L3VNI[&#39;vni&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">vrf context Tenant-1</span>
<span class="l l-Scalar l-Scalar-Plain">vni {{L3VNI[&#39;vni&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">rd auto</span>
<span class="l l-Scalar l-Scalar-Plain">address-family ipv4 unicast</span>
<span class="l l-Scalar l-Scalar-Plain">route-target both auto</span>
<span class="l l-Scalar l-Scalar-Plain">route-target both auto evpn</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>

<span class="l l-Scalar l-Scalar-Plain">fabric forwarding anycast-gateway-mac 0000.2222.3333</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">#for loop to configure SVI</span>
<span class="l l-Scalar l-Scalar-Plain">{% for L2VNI in L2VNI %}</span>
<span class="l l-Scalar l-Scalar-Plain">interface Vlan{{L2VNI[&#39;vlan_id&#39;]}}</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">no shutdown</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">vrf member Tenant-1</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">no ip redirects</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">ip address {{L2VNI[&#39;ip_add&#39;]}}/{{L2VNI[&#39;mask&#39;]}}</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">fabric forwarding mode anycast-gateway</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
<span class="l l-Scalar l-Scalar-Plain">{% for L3VNI in L3VNI %}</span>
<span class="l l-Scalar l-Scalar-Plain">interface vlan{{L3VNI[&#39;vlan_id&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">no shutdown</span>
<span class="l l-Scalar l-Scalar-Plain">vrf member Tenant-1</span>
<span class="l l-Scalar l-Scalar-Plain">ip forward</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
<span class="l l-Scalar l-Scalar-Plain">#for loop to enable PIM on L3 interface</span>
<span class="l l-Scalar l-Scalar-Plain">{% for interface in L3_interfaces %}</span>
<span class="l l-Scalar l-Scalar-Plain">interface {{interface[&#39;interface&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">ip pim sparse-mode</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>

<span class="l l-Scalar l-Scalar-Plain">interface nve1</span>
<span class="l l-Scalar l-Scalar-Plain">no shutdown</span>
<span class="l l-Scalar l-Scalar-Plain">source-interface loopback1</span>
<span class="l l-Scalar l-Scalar-Plain">host-reachability protocol bgp</span>
<span class="l l-Scalar l-Scalar-Plain">{% for L2VNI in L2VNI %}</span>
<span class="l l-Scalar l-Scalar-Plain">member vni {{L2VNI[&#39;vni&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">mcast-group {{L2VNI[&#39;mcast&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
<span class="l l-Scalar l-Scalar-Plain">{% for L3VNI in L3VNI %}</span>
<span class="l l-Scalar l-Scalar-Plain">member vni {{L3VNI[&#39;vni&#39;]}} associate-vrf</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>

<span class="l l-Scalar l-Scalar-Plain">router bgp {{ asn }}</span>
<span class="l l-Scalar l-Scalar-Plain">router-id {{ router_id }}</span>
<span class="l l-Scalar l-Scalar-Plain">address-family ipv4 unicast</span>
<span class="l l-Scalar l-Scalar-Plain">address-family l2vpn evpn</span>
<span class="l l-Scalar l-Scalar-Plain">retain route-target all</span>
<span class="l l-Scalar l-Scalar-Plain">#for loop to configure bgp neighbor with spine</span>
<span class="l l-Scalar l-Scalar-Plain">{% for neighbor in bgp_neighbors %}</span>
<span class="l l-Scalar l-Scalar-Plain">neighbor {{neighbor[&#39;neighbor&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">remote-as {{neighbor[&#39;remote_as&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">update-source {{neighbor[&#39;update_source&#39;]}}</span>
<span class="l l-Scalar l-Scalar-Plain">address-family ipv4 unicast</span>
<span class="l l-Scalar l-Scalar-Plain">send-community both</span>
<span class="l l-Scalar l-Scalar-Plain">address-family l2vpn evpn</span>
<span class="l l-Scalar l-Scalar-Plain">send-community both</span>
<span class="l l-Scalar l-Scalar-Plain">!</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
<span class="l l-Scalar l-Scalar-Plain">evpn</span>
<span class="l l-Scalar l-Scalar-Plain">{% for L2VNI in L2VNI %}</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">vni {{L2VNI[&#39;vni&#39;]}} l2</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">rd auto</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">route-target import auto</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">route-target export auto</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
</code></pre></div>
<ul>
<li>Next on <strong>Atom</strong>, you can <strong>Select</strong> <code>File</code> and <code>Save</code> to push template file to Ansible node.</li>
</ul>
<hr />
<h3 id="step-11-create-playbook-for-jinja2_leaf-role">Step 11: Create playbook for jinja2_leaf role</h3>
<p>The playbook for jinja2_leaf roles has two tasks:</p>
<ol>
<li>First task uses ansible "<strong>template</strong>" module to generate configuration file based on jinja2 template created in last step. The configuration file is saved in <code>files</code> directory.</li>
<li>Second task is to push the configuration using ansible "<strong>cisco.nxos.nxos_config</strong>" module to switch.</li>
</ol>
<p>“<strong>ansible-galaxy</strong>” automatically creates empty “<strong>main.yml</strong>” file under “<strong>tasks</strong>” folder.  We are going to use “<strong>Atom</strong>” to edit this main.yml file.</p>
<ul>
<li>On <strong>Atom</strong>, you can <strong>Select</strong> project folder <code>EVPN-Ansible</code> and <strong>Click</strong> to edit “<code>main.yml</code>” file under “<code>roles/jinja2_leaf/tasks/</code>” and include following content:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="c1"># tasks file for jinja2_leaf</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Generate Leaf Config</span>
<span class="w">    </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">src=leaf.j2 dest=roles/jinja2_leaf/files/{{inventory_hostname}}.cfg</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Push Leaf Config</span>
<span class="w">    </span><span class="nt">cisco.nxos.nxos_config</span><span class="p">:</span>
<span class="w">      </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">roles/jinja2_leaf/files/{{inventory_hostname}}.cfg</span>
<span class="w">      </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">none</span>
</code></pre></div>
<p>Below screenshot shows how the contents of <code>jinja2_leaf/taks/main.yml</code> file looks like in Atom:</p>
<p><img alt="" src="../pic/3-11-1.png" /></p>
<hr />
<h3 id="step-12-run-jinja2_fabric-playbook">Step 12: Run Jinja2_fabric playbook</h3>
<p>In this section you will run the playbook created in step 8, this will generate configuration file for Spine-2 and Leaf-4 switches. It will also push the configuration file to both switches.</p>
<ul>
<li>Before running the ansible-playbook, on the <strong>MTPuTTy</strong> you can <strong>login/SSH</strong> into the <strong>leaf-4</strong>, and verify that no bgp configurations exist by running below command:</li>
</ul>
<div class="highlight"><pre><span></span><code>show running bgp
</code></pre></div>
<p>Below screenshot shows the output of above command:</p>
<p><img alt="" src="../pic/3-12-0.png" /></p>
<ul>
<li>On the Ansible node (in MTputty SSH session), run the below command (<code>ansible-playbook jinja2_fabric.yml</code>) to execute the playbook:</li>
</ul>
<div class="highlight"><pre><span></span><code>ansible-playbook jinja2_fabric.yml
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It might take couple of minutes for the configuration to be pushed to via the Ansible Server. It is working in the background.</p>
</div>
<p>Below screenshot shows the execution of above command:</p>
<p><strong>Note:</strong> You can ignore the <code>[WARNING]</code> messages for <code>ansible-pylibssh</code> and <code>timeout for nxos_facts</code>.
<strong>Note:</strong> You can ignore the <code>timeout for nxos_facts</code> message.</p>
<p><img alt="" src="../pic/3-12-1b.png" /></p>
<ul>
<li>After the configuration push is successful, <strong>login/SSH</strong> (on <strong>MTpuTT</strong> SSH session) to <strong>leaf-4</strong> switch to verify configuration has been pushed by running below command:</li>
</ul>
<div class="highlight"><pre><span></span><code>show running-config bgp
</code></pre></div>
<p>The output of above command is shown below:</p>
<p><img alt="" src="../pic/3-12-2.png" /></p>
<hr />
<p><strong>Congratulations: you have successfully concluded this task of using jinja2 templates with Ansible for Cisco Nexus switches</strong></p>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.instant", "navigation.top", "search.suggest"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fac441b0.min.js"></script>
      
    
  </body>
</html>